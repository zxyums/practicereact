import { ColDef } from 'ag-grid-community';
import React from 'react';

const updatedDateColumn: ColDef = {
  field: 'updatedDate',
  headerName: 'Last Update Date (UTC)',
  minWidth: 240,
  width: 240,
  sortable: true,

  // ✅ Ensure the value is correctly retrieved from the data (prevents empty display issues)
  valueGetter: (params) => {
    return params.data?.updatedDate ? new Date(params.data.updatedDate).toISOString() : null;
  },

  // ✅ Sorting: Null values go last, proper date comparison
  comparator: (date1: string | null, date2: string | null): number => {
    if (!date1 && !date2) return 0; // Both are null
    if (!date1) return 1; // Null should go last
    if (!date2) return -1; // Null should go last

    return new Date(date1).getTime() - new Date(date2).getTime(); // Sort ascending
  },

  // ✅ Ensure correct UTC display in grid and local time in tooltip
  cellRenderer: (params: { value: string | null }) => {
    if (!params.value) return ''; // Handle null values gracefully

    const utcDate = new Date(params.value);

    // ✅ Display UTC time in the grid (DD-MMM-YYYY HH:mm UTC)
    const utcFormatted: string = utcDate.toLocaleString('en-GB', {
      day: '2-digit',
      month: 'short',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: false, // 24-hour format
      timeZone: 'UTC', // Ensure it's in UTC
    }) + ' UTC';

    // ✅ Convert UTC date manually to the user's actual local timezone
    const userTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    const localDate = new Date(utcDate.toLocaleString('en-US', { timeZone: userTimeZone }));

    // ✅ Format Local Time Correctly (DD-MMM-YYYY HH:mm)
    const localFormatted: string = `${localDate.getDate()}-${localDate.toLocaleString('en-GB', { month: 'short' })}-${localDate.getFullYear()} ` +
      `${String(localDate.getHours()).padStart(2, '0')}:${String(localDate.getMinutes()).padStart(2, '0')} ${userTimeZone}`;

    return (
      <div title={`Local Time: ${localFormatted}`}>
        {utcFormatted}
      </div>
    );
  }
};

export default updatedDateColumn;